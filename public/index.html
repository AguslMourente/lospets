<!doctype html>
<html lang="es">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LostPets — Cerca de mí</title>
<link rel="stylesheet" href="./styles.css" />
<body>
  <header class="wrap head">
    <h1>LostPets</h1>
    <nav>
      <a href="/auth.html">Ingresar / Mis mascotas</a>
    </nav>
  </header>

  <main class="wrap">
    <section class="panel">
      <h2>Mascotas perdidas cerca tuyo</h2>
      <div class="row">
        <button id="geoBtn">Usar mi ubicación</button>
        <div class="sep">o</div>
        <input id="lat" type="number" step="any" placeholder="Lat" />
        <input id="lng" type="number" step="any" placeholder="Lng" />
        <input id="radius" type="number" step="1" value="5" min="1" style="width:80px" />
        <button id="searchBtn">Buscar</button>
      </div>
      <div id="results" class="grid"></div>
      <p id="hint" class="muted"></p>
    </section>
  </main>

  <!-- Modal reportar -->
  <dialog id="reportDlg">
    <form id="reportForm" method="dialog" class="panel">
      <h3>Reportar info de <span id="petName"></span></h3>
      <input type="hidden" id="petId" />
      <label>Tu nombre <input id="rName" required /></label>
      <label>Tu teléfono <input id="rPhone" required /></label>
      <label>¿Dónde lo viste? <input id="rLocation" /></label>
      <label>Detalles <textarea id="rDetails" rows="3"></textarea></label>
      <div class="row right">
        <button id="cancelBtn" type="reset">Cancelar</button>
        <button id="sendBtn" type="submit">Enviar</button>
      </div>
      <p id="msg" class="muted"></p>
    </form>
  </dialog>

  <script>
    const resultsEl = document.getElementById("results");
    const hintEl = document.getElementById("hint");

    function card(p) {
      const img = p.image_url || p.imageUrl || "";
      const loc = p.location || "";
      const name = p.name || "Sin nombre";
      const id = p.objectID || p.id;

      const el = document.createElement("article");
      el.className = "card";
      el.innerHTML = `
        <div class="img">${img ? `<img src="${img}" alt="${name}"/>` : `<div class="ph">Sin foto</div>`}</div>
        <div class="info" style="padding:10px">
          <h4 style="margin:0 0 6px">${name}</h4>
          <p class="muted" style="margin:0 0 10px">${loc}</p>
          <button data-id="${id}" data-name="${name}" class="report">Reportar información</button>
        </div>`;
      return el;
    }

    function bindReportButtons() {
      document.querySelectorAll("button.report").forEach(btn => {
        btn.onclick = () => openReportDlg(btn.dataset.id, btn.dataset.name);
      });
    }

    function render(list) {
      resultsEl.innerHTML = "";
      if (!list || !list.length) {
        hintEl.textContent = "No hay resultados (si no configuraste Algolia, esto es normal).";
        return;
      }
      hintEl.textContent = "";
      list.forEach(p => resultsEl.appendChild(card(p)));
      bindReportButtons();
    }

    async function search(lat, lng, radiusKm) {
      const u = new URL(location.origin + "/pets-near");
      u.searchParams.set("lat", lat);
      u.searchParams.set("lng", lng);
      u.searchParams.set("radiusKm", radiusKm || 5);
      const r = await fetch(u);
      const j = await r.json();
      render(j);
    }

    document.getElementById("geoBtn").onclick = () => {
      navigator.geolocation.getCurrentPosition(
        pos => {
          const lat = pos.coords.latitude.toFixed(6);
          const lng = pos.coords.longitude.toFixed(6);
          document.getElementById("lat").value = lat;
          document.getElementById("lng").value = lng;
          search(lat, lng, document.getElementById("radius").value);
        },
        _ => hintEl.textContent = "No se pudo obtener tu ubicación.",
        { enableHighAccuracy: true, timeout: 8000 }
      );
    };

    document.getElementById("searchBtn").onclick = () => {
      const lat = parseFloat(document.getElementById("lat").value);
      const lng = parseFloat(document.getElementById("lng").value);
      const r = parseInt(document.getElementById("radius").value || "5", 10);
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
        hintEl.textContent = "Ingresá lat y lng válidos, o usa 'Usar mi ubicación'.";
        return;
      }
      search(lat, lng, r);
    };

    // ----- Reportar -----
    const dlg = document.getElementById("reportDlg");
    const petNameSpan = document.getElementById("petName");
    const petIdInput = document.getElementById("petId");
    const msgEl = document.getElementById("msg");

    function openReportDlg(id, name) {
      petIdInput.value = id;
      petNameSpan.textContent = name;
      msgEl.textContent = "";
      dlg.showModal();
    }
    document.getElementById("cancelBtn").onclick = () => dlg.close();

    document.getElementById("reportForm").onsubmit = async (ev) => {
      ev.preventDefault();
      const body = {
        petId: Number(petIdInput.value),
        reporterName: document.getElementById("rName").value.trim(),
        reporterPhone: document.getElementById("rPhone").value.trim(),
        location: document.getElementById("rLocation").value.trim(),
        details: document.getElementById("rDetails").value.trim(),
      };
      const r = await fetch("/reports", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      if (r.ok) {
        msgEl.textContent = "¡Gracias! Aviso enviado.";
        setTimeout(() => dlg.close(), 900);
      } else {
        msgEl.textContent = "No se pudo enviar. Intentá de nuevo.";
      }
    };
  </script>
</body>
</html>
